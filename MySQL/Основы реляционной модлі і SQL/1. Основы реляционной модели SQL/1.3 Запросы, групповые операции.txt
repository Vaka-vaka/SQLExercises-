Выбор уникальных элементов столбца
Чтобы отобрать уникальные элементы некоторого столбца используется ключевое слово DISTINCT, которое размещается сразу после SELECT.
Пример
Выбрать различных авторов, книги которых хранятся в таблице book.
Запрос:
SELECT DISTINCT author
FROM book;
Результат:
+------------------+
| author           |
+------------------+
| Булгаков М.А.    |
| Достоевский Ф.М. |
| Есенин С.А.      |
+------------------+
Другой способ – использование оператора GROUP BY, который группирует данные при выборке, имеющие
 одинаковые значения в некотором столбце. Столбец, по которому осуществляется группировка, указывается после GROUP BY .
С помощью GROUP BY можно выбрать уникальные элементы столбца, по которому осуществляется группировка.
 Результат будет точно такой же как при использовании DISTINCT.
Запрос:
SELECT  author
FROM book
GROUP BY author;
Задание
Отобрать различные (уникальные) элементы столбца amount таблицы book.
Результат (попробуйте решать задания без известного результата, если не получится - раскройте его)
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 56,287 learners
Total 91% of tries are correct
 Good news for you, correct!
Query result: +--------+ | amount | +--------+ | 3 | | 5 | | 10 | | 15 | +--------+ Affected rows: 4
Hide
 
1
SELECT DISTINCT amount
2
FROM book;
3

4

5

6

7
==========================================================================
Выборка данных, групповые функции SUM и COUNT
При группировке над элементами столбца, входящими в группу можно выполнить различные действия, 
например, просуммировать их или найти количество элементов в группе.

Подробно рассмотрим, как осуществляется группировка данных по некоторому столбцу и вычисления
 над группой на следующем примере:

SELECT author, sum(amount), count(amount)
FROM book
GROUP BY author;
1. В таблице book определяются строки, в которых в столбце author одинаковые значения:



Получили 3 различные группы:

группа I объединяет две записи, у которых в столбце author значение Булгаков М.А.;
группа II объединяет три записи, у которых в столбце author значение Достоевский Ф.М.;
группа III объединяет одну запись, у которой в столбце author значение Есенин С.А.
2. Вместо каждой группы в результирующий запрос включается  одна запись. Запись как минимум включает
 значение столбца, по которому осуществляется группировка (в нашем случае это author):



3. Дальше можно выполнить вычисления над элементами КАЖДОЙ группы в отдельности, например, посчитать 
общее количество экземпляров книг каждого автора. Для этого используется групповая функция SUM(), а в
 скобках указывается столбец, по которому нужно выполнить суммирование ( в нашем случае amount):



4. Также можно посчитать, сколько записей относится к группе. Для этого используется функция COUNT(),
 в скобках можно указать ЛЮБОЙ столбец из группы, если группа не содержит пустых значений (ниже приведен
 пример, в котором показано, как работает COUNT(), если в группе есть пустые значения):



Пример

Посчитать, сколько экземпляров книг каждого автора хранится на складе.

Запрос:

SELECT author, SUM(amount)
FROM book
GROUP BY author;
Результат:

+------------------+-------------+
| author           | SUM(amount) |
+------------------+-------------+
| Булгаков М.А.    | 8           |
| Достоевский Ф.М. | 23          |
| Есенин С.А.      | 15          |
+------------------+-------------+
Примечание
Пример

Посчитать, сколько различных книг каждого автора хранится на складе.

Только для этого примера в таблицу book добавлена запись с пустыми значениями в столбцах amount и price:

+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 7       | Черный человек        | Есенин С.А.      | Null   | Null   |
+---------+-----------------------+------------------+--------+--------+
Запрос:

/* чтобы проверить запрос, добавьте в таблицу строку */
INSERT INTO book (title, author, price, amount) VALUES ('Черный человек','Есенин С.А.', Null, Null);

SELECT author, COUNT(author), COUNT(amount), COUNT(*)
FROM book
GROUP BY author;
Результат:

+------------------+---------------+---------------+----------+
| author           | COUNT(author) | COUNT(amount) | COUNT(*) |
+------------------+---------------+---------------+----------+
| Булгаков М.А.    | 2             | 2             | 2        |
| Достоевский Ф.М. | 3             | 3             | 3        |
| Есенин С.А.      | 2             | 1             | 2        |
+------------------+---------------+---------------+----------+
Из таблицы с результатами запроса видно, что функцию COUNT() можно применять к любому столбцу,
 в том числе можно использовать и *, если таблица не содержит пустых значений. Если же в столбцах 
есть значения Null, (для группы по автору Есенин в нашем примере), то

COUNT(*) —  подсчитывает  все записи, относящиеся к группе, в том числе и со значением NULL;
COUNT(имя_столбца) — возвращает количество записей конкретного столбца (только NOT NULL), относящихся к группе.
ВАЖНО.

Если столбец указан в SELECT  БЕЗ применения групповой функции, то он обязательно должен быть указан и вGROUP BY.Иначе получим ошибку.
Между названием функции и скобкой НЕЛЬЗЯ СТАВИТЬ ПРОБЕЛ. Это особенность платформы.
Задание
Посчитать, количество различных книг и количество экземпляров книг каждого автора , хранящихся на складе.
  Столбцы назвать Автор, Различных_книг и Количество_экземпляров соответственно.

Результат
Пояснение
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 53,372 learners
Total 51% of tries are correct
 Great work!
Query result:
+------------------+----------------+------------------------+
| Автор            | Различных_книг | Количество_экземпляров |
+------------------+----------------+------------------------+
| Булгаков М.А.    | 2              | 8                      |
| Достоевский Ф.М. | 3              | 23                     |
| Есенин С.А.      | 1              | 15                     |
+------------------+----------------+------------------------+
Affected rows: 3

1
SELECT author 'Автор',
2
    COUNT(author) Различных_книг,
3
    SUM(amount) Количество_экземпляров
4
FROM book
5
GROUP BY author;
======================================================================================
Выборка данных, групповые функции MIN, MAX и AVG
К групповым функциям SQL относятся: MIN(), MAX() и AVG(), которые вычисляют минимальное, 
максимальное и среднее значение элементов столбца, относящихся к группе.

Пример

Вывести минимальную цену книги каждого автора

Запрос:

SELECT author, MIN(price) AS min_price
FROM book
GROUP BY author;
Результат:

+------------------+-----------+
| author           | min_price |
+------------------+-----------+
| Булгаков М.А.    | 540.50    |
| Достоевский Ф.М. | 460.00    |
| Есенин С.А.      | 650.00    |
+------------------+-----------+
Задание
Вывести фамилию и инициалы автора, минимальную, максимальную и среднюю цену книг 
каждого автора . Вычисляемые столбцы назвать Минимальная_цена, Максимальная_цена и Средняя_цена
 соответственно.

Результат
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 53,272 learners
Total 77% of tries are correct
 Totally right.
Query result:
+------------------+------------------+-------------------+--------------+
| author           | Минимальная_цена | Максимальная_цена | Средняя_цена |
+------------------+------------------+-------------------+--------------+
| Булгаков М.А.    | 540.50           | 670.99            | 605.745000   |
| Достоевский Ф.М. | 460.00           | 799.01            | 579.836667   |
| Есенин С.А.      | 650.00           | 650.00            | 650.000000   |
+------------------+------------------+-------------------+--------------+
Affected rows: 3

1
SELECT author, 
2
    MIN(price) Минимальная_цена, 
3
    MAX(price) Максимальная_цена, 
4
    AVG(price) Средняя_цена
5
FROM book
6
GROUP BY author;
===========================================================================================
Выборка данных c вычислением, групповые функции
В качестве аргумента групповых функций  SQL может использоваться не только столбец, но и любое допустимое в SQL арифметическое выражение.

Пример

Вывести суммарную стоимость книг каждого автора.

Запрос:

SELECT author, SUM(price * amount) AS Стоимость
FROM book
GROUP BY author;
Результат:

+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Булгаков М.А.    | 4715.47   |
| Достоевский Ф.М. | 11802.03  |
| Есенин С.А.      | 9750.00   |
+------------------+-----------+
Групповые функции могут быть элементами выражений. Например, при вычислении средней 
стоимости книг каждого автора на предыдущем шаге получились значения с шестью знаками после
 запятой. А поскольку это деньги, значения нужно округлить до 2 знаков после запятой.

 Пример

Найти среднюю цену книг каждого автора.

Запрос:

SELECT author, ROUND(AVG(price),2) AS Средняя_цена
FROM book
GROUP BY author;
Результат:

+------------------+--------------+
| author           | Средняя_цена |
+------------------+--------------+
| Булгаков М.А.    | 605.75       |
| Достоевский Ф.М. | 579.84       |
| Есенин С.А.      | 650.00       |
+------------------+--------------+
Задание
Для каждого автора вычислить суммарную стоимость книг S (имя столбца Стоимость), а
 также вычислить налог на добавленную стоимость  для полученных сумм (имя столбца НДС ) ,
 который включен в стоимость и составляет k = 18%,  а также стоимость книг  (Стоимость_без_НДС)
 без него. Значения округлить до двух знаков после запятой. В запросе для расчета НДС(tax) 
 и Стоимости без НДС(S_without_tax) использовать следующие формулы:

tax= {{S *{ k \over 100}} \over {1+{k\over 100}}},
tax= 
1+ 
100
k
​
 
S∗ 
100
k
​
 
​
 ,

S\_without\_tax= {{S} \over {1+{k\over 100}}}
S_without_tax= 
1+ 
100
k
​
 
S
​
 

Результат
Пояснение
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 50,847 learners
Total 52% of tries are correct
 Right.
Query result:
+------------------+-----------+---------+-------------------+
| author           | Стоимость | НДС     | Стоимость_без_НДС |
+------------------+-----------+---------+-------------------+
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |
+------------------+-----------+---------+-------------------+
Affected rows: 3

1
SELECT author, 
2
    ROUND(SUM(price * amount),2) 'Стоимость',
3
    ROUND(SUM((price*amount)*18/100)/(1+18/100),2) 'НДС',
4
    ROUND(SUM(price*amount)/(1+18/100),2) 'Стоимость_без_НДС'    
5
FROM book
6
GROUP BY author;
==================================================================================
Вычисления по таблице целиком
Групповые функции позволяют вычислять итоговые значения по всей таблице. Например, можно 
посчитать общее количество книг на складе, вычислить суммарную стоимость и пр. Для этого 
после ключевого слова SELECT указывается групповая функция для выражения или имени столбца, 
а ключевые слова GROUP BY опускаются.

Пример

Посчитать количество экземпляров книг на складе.

Запрос:

SELECT SUM(amount) AS Количество
FROM book;
Результат:

+------------+
| Количество |
+------------+
| 46         |
+------------+ 
Результатом таких запросов является единственная строка с вычисленными по таблице значениями.

 Пример

Посчитать общее количество экземпляров книг на складе и их стоимость .

Запрос:

SELECT SUM(amount) AS Количество, 
    SUM(price * amount) AS Стоимость
FROM book;
Результат:

+------------+-----------+
| Количество | Стоимость |
+------------+-----------+
| 46         | 26267.50  |
+------------+-----------+
Задание
Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену уникальных книг
 на складе. Названия столбцов Минимальная_цена, Максимальная_цена, Средняя_цена соответственно.
 Среднюю цену округлить до двух знаков после запятой.

Пояснение. В задании нужно посчитать среднюю цену уникальных книг на складе, а не среднюю цену всех экземпляров книг.

Результат
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 51,293 learners
Total 70% of tries are correct
 You're right!
Query result:
+------------------+-------------------+--------------+
| Минимальная_цена | Максимальная_цена | Средняя_цена |
+------------------+-------------------+--------------+
| 460.00           | 799.01            | 600.17       |
+------------------+-------------------+--------------+
Affected rows: 1

1
SELECT 
2
    MIN(price) Минимальная_цена,
3
    MAX(price) Максимальная_цена,
4
    ROUND(AVG(DISTINCT price),2) Средняя_цена /*СЕРЕДНЯ УНІКАЛЬНА ЦІНА*/    
5
FROM book;
===============================================================================================
Выборка данных по условию, групповые функции
В запросы с групповыми функциями можно включать условие отбора строк, которое в 
обычных запросах записывается после WHERE. В запросах с групповыми функциями вместо
 WHERE используется ключевое слово HAVING , которое размещается после оператора GROUP BY.

Пример

Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000.

Запрос:

SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000; 
Результат:

+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
| Есенин С.А.      | 650.00           | 650.00            |
+------------------+------------------+-------------------+
Также в запросах с группировкой можно сортировать данные.

 Пример

Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000. Результат вывести по убыванию минимальной цены.

Запрос:

SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000 
ORDER BY Минимальная_цена DESC;
Результат:

+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Есенин С.А.      | 650.00           | 650.00            |
| Достоевский Ф.М. | 460.00           | 799.01            |
+------------------+------------------+-------------------+
Пояснение
Задание
Вычислить среднюю цену и суммарную стоимость тех книг, количество экземпляров которых 
принадлежит интервалу от 5 до 14, включительно. Столбцы назвать Средняя_цена и Стоимость,
 значения округлить до 2-х знаков после запятой.

Результат
+--------------+-----------+
| Средняя_цена | Стоимость |
+--------------+-----------+
| 493.67       | 12107.50  |
+--------------+-----------+
Пояснение
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 50,710 learners
Total 56% of tries are correct
 Great work!
Query result:
+--------------+-----------+
| Средняя_цена | Стоимость |
+--------------+-----------+
| 493.67       | 12107.50  |
+--------------+-----------+
Affected rows: 1

(price), 2) Средняя_цена,
       SUM(price*amount) AS Стоимость
FROM book
WHERE amount BETWEEN 5 AND 14;
1
/*SELECT  
2
    ROUND(AVG(price),2) Средняя_цена,
3
    SUM(price * amount) AS Стоимость
4
FROM book
5
GROUP BY amount
6
HAVING amount BETWEEN 5 AND 14; */
7
​
8
SELECT ROUND(AVG(price), 2) Средняя_цена,
9
       SUM(price*amount) AS Стоимость
10
FROM book
11
WHERE amount BETWEEN 5 AND 14;
==================================================================================================
Выборка данных по условию, групповые функции, WHERE и HAVING
Для этого урока теоретическая часть подготовлена Alexandra Klinnikova, спасибо большое!

WHERE и HAVING могут использоваться в одном запросе. При этом необходимо учитывать порядок выполнения  SQL запроса на выборку на СЕРВЕРЕ:

FROM
WHERE
GROUP BY
HAVING
SELECT
ORDER BY
Сначала определяется таблица, из которой выбираются данные (FROM), затем из этой таблицы отбираются 
записи в соответствии с условием  WHERE, выбранные данные агрегируются (GROUP BY),  из агрегированных
 записей выбираются те, которые удовлетворяют условию после HAVING. Потом формируются данные результирующей
 выборки, как это указано после SELECT ( вычисляются выражения, присваиваются имена и пр. ). Результирующая
 выборка сортируется, как указано после ORDER BY.

Важно! Порядок ВЫПОЛНЕНИЯ запросов - это не порядок ЗАПИСИ ключевых слов в запросе на выборку. 
Порядок записи (синтаксис запроса) остается таким же, как рассматривался ранее в курсе. Порядок 
ВЫПОЛНЕНИЯ  нужен для того, чтобы понять, почему, например, в WHERE нельзя использовать имена 
выражений из SELECT. Просто SELECT выполняется компилятором позже, чем WHERE, поэтому ему неизвестно,
 какое там выражение написано.

Пример

Вывести максимальную и минимальную цену книг каждого автора, кроме Есенина, количество экземпляров книг которого больше 10. 

SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
WHERE author <> 'Есенин С.А.'
GROUP BY author
HAVING SUM(amount) > 10;
Результат:

+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
+------------------+------------------+-------------------+
Другим способом решения примера является запрос:

SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(amount) > 10 AND author <> 'Есенин С.А.';
Не смотря на то что результат будет одинаковым, 
так делать не рекомендуется. «Потому что как написано - 
запрос сначала выбирает всех авторов, потом выводит данные, 
рассчитывая минимальное и максимальное значение цены для каждого,
 и только после всего убирает Есенина. Можно убрать Есенина в данном
 случае раньше и не использовать ресурсы базы для расчета его минимального 
и максимального значения, как это сделано в первом варианте. На небольшой базе
 быстродействия не ощутить, но если выполнять такое на продуктивной, то второй 
вариант значительно проигрывает...»[Alexandra Klinnikova].

Задание
Посчитать стоимость всех экземпляров каждого автора без учета книг «Идиот» и «Белая гвардия».
 В результат включить только тех авторов, у которых суммарная стоимость книг (без учета книг «Идиот» и «Белая гвардия») 
более 5000 руб. Вычисляемый столбец назвать Стоимость. Результат отсортировать по убыванию стоимости.

Результат
+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |
+------------------+-----------+
Структура и наполнение таблицы book
Enter an SQL query
Correct answer from 49,262 learners
Total 53% of tries are correct
 Good job.
Query result:
+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |
+------------------+-----------+
Affected rows: 2

1
SELECT author,
2
    SUM(price*amount) AS Стоимость
3
FROM book
4
WHERE title NOT IN ('Идиот', 'Белая гвардия')
5
GROUP BY author
6
HAVING SUM(price*amount) > 5000
7
ORDER BY SUM(price*amount) DESC;
8
​=====================================================================
Задание
Придумайте один или несколько запросов к нашей таблице book, используя групповые функции. Проверьте, правильно ли они работают.

При желании можно формулировку запросов  разместить в комментариях. 

Размещенные задания можно использовать для закрепления материала урока.

Оценивайте понравившиеся Вам запросы.

В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. 

Структура и наполнение таблицы book:

book_id	title	author	price	amount
INT PRIMARY KEY AUTO_INCREMENT	VARCHAR(50)	VARCHAR(30)	DECIMAL(8,2)	INT
1	Мастер и Маргарита	Булгаков М.А.	670.99	3
2	Белая гвардия	Булгаков М.А.	540.50	5
3	Идиот	Достоевский Ф.М.	460.00	10
4	Братья Карамазовы	Достоевский Ф.М.	799.01	3
5	Игрок	Достоевский Ф.М.	480.50	10
6	Стихотворения и поэмы	Есенин С.А.	650.00	15
Enter an SQL query
Correct answer from 45,699 learners
Total 79% of tries are correct
 Right.
Query result:
+---------------+------------------+-----------------+------------+
| author        | Минимальная цена | Количество книг | Число книг |
+---------------+------------------+-----------------+------------+
| Булгаков М.А. | 540.50           | 8               | 2          |
+---------------+------------------+-----------------+------------+
Affected rows: 1

1
/*Узнать сколько авторов, у которых есть книги 
со стоимостью более 500 и количеством более 1 шт на складе, при количестве различных названий произведений не менее 2-х.
 Вывести автора, количество различных произведений автора, минимальную цену и количество книг на складе.*/
2
​
3
SELECT author,
4
    MIN(price) AS 'Минимальная цена',
5
    SUM(amount) AS 'Количество книг',
6
    COUNT(title) AS 'Число книг'
7
FROM book
8
WHERE price > 500 AND amount > 1
9
GROUP BY author
10
HAVING COUNT(title) >=2; 
11
​
12
​
